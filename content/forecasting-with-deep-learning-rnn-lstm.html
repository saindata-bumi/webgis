
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Forecaster with Deep Learning &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/forecasting-with-deep-learning-rnn-lstm';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Pengantar
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="peramalan.html">Peramalan  Deret Berkala (Time Series)</a></li>





</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fcontent/forecasting-with-deep-learning-rnn-lstm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/forecasting-with-deep-learning-rnn-lstm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Forecaster with Deep Learning</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks-rnn-and-long-short-term-memory-lstm">Recurrent Neural Networks (RNN) and Long Short-Term Memory (LSTM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#libraries">Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-in-time-series-modeling">Types of problems in time series modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-step-forecasting-predict-one-step-ahead-of-a-single-series-using-the-same-series-as-predictor">1:1 Single-Step Forecasting - Predict one step ahead of a single series using the same series as predictor.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-step-forecasting-predict-a-single-series-using-the-same-series-as-predictor-multiple-steps-ahead">1:1 Multiple-Step Forecasting - Predict a single series using the same series as predictor. Multiple steps ahead.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#n-1-multiple-step-forecasting-predict-one-series-using-multiple-series-as-predictors">N:1 Multiple-Step Forecasting - Predict one series using multiple series as predictors.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#n-m-multiple-step-forecasting-multiple-time-series-with-multiple-outputs">N:M Multiple-Step Forecasting - Multiple time series with multiple outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-compile-tensorflow-models">Create and compile Tensorflow models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-training-and-test-matrices">Get training and test matrices</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="forecaster-with-deep-learning">
<h1>Forecaster with Deep Learning<a class="headerlink" href="#forecaster-with-deep-learning" title="Link to this heading">#</a></h1>
<section id="recurrent-neural-networks-rnn-and-long-short-term-memory-lstm">
<h2>Recurrent Neural Networks (RNN) and Long Short-Term Memory (LSTM)<a class="headerlink" href="#recurrent-neural-networks-rnn-and-long-short-term-memory-lstm" title="Link to this heading">#</a></h2>
<p>Recurrent Neural Networks (RNN) are a type of neural networks designed to process data that follows a sequential order. In conventional neural networks, such as feedforward networks, information flows in one direction, from input to output through hidden layers, without considering the sequential structure of the data. In contrast, RNNs maintain internal states or memories, which allow them to remember past information and use it to predict future data in the sequence.</p>
<p>The basic unit of an RNN is the recurrent cell. This cell takes two inputs: the current input and the previous hidden state. The hidden state can be understood as a “memory” that retains information from previous iterations. The current input and the previous hidden state are combined to calculate the current output and the new hidden state. This output is used as input for the next iteration, along with the next input in the data sequence.</p>
<p>Despite the advances that have been achieved with RNN architectures, they have limitations to capture long-term patterns. This is why variants such as  Long Short-Term Memory (LSTM) and Gated Recurrent Units (GRU) have been developed, which address these problems and allow long-term information to be retained more effectively.</p>
<p align="center"><img src='../img/schema-rnn-model.jpg'style="width: 600px"></p>
<center><font size='2.5'> <i>RNN diagram. Fuente: James, G., Witten, D., Hastie, T., & Tibshirani, R. (2013). An introduction to statistical learning (1st ed.) [PDF]. Springer.</i></font></center>
<p>Long Short-Term Memory (LSTM) neural networks are a specialized type of RNNs designed to overcome the limitations associated with capturing long-term temporal dependencies. Unlike traditional RNNs, LSTMs incorporate a more complex architecture, introducing memory units and gate mechanisms to improve information management over time.</p>
<p><strong>Structure of LSTMs</strong></p>
<p>LSTMs have a modular structure consisting of three fundamental gates: the forget gate, the input gate, and the output gate. These gates work together to regulate the flow of information through the memory unit, allowing for more precise control over what information to retain and what to forget.</p>
<ul class="simple">
<li><p><strong>Forget Gate:</strong> Regulates how much information should be forgotten and how much should be retained, combining the current input and the previous output through a sigmoid function.</p></li>
<li><p><strong>Input Gate:</strong> Decides how much new information should be added to long-term memory.</p></li>
<li><p><strong>Output Gate:</strong> Determines how much information from the current memory will be used for the final output, combining the current input and memory information through a sigmoid function.</p></li>
</ul>
<p align="center"><img src='https://databasecamp.de/wp-content/uploads/lstm-architecture-1024x709.png'style="width: 400px"></p>
<center><font size='2.5'> <i>Diagram of the inputs and outputs of an LSTM. Fuente: codificandobits https://databasecamp.de/wp-content/uploads/lstm-architecture-1024x709.png.</i></font></center>
<div class="admonition note" name="html-admonition" style="background: rgba(0,191,191,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #00bfa5; border-color: #00bfa5; padding-left: 10px; padding-right: 10px;">
<p class="title">
    <i style="font-size: 18px; color:#00bfa5;"></i>
    <b style="color: #00bfa5;">&#128161 Tip</b>
</p>
<p>To learn more about forecasting with deep learning  models visit our examples:</p>
<ul>
    <li>
    <a href="https://www.cienciadedatos.net/documentos/py54-forecasting-with-deep-learning.html">Deep Learning for time series forecasting: Recurrent Neural Networks (RNN) and Long Short-Term Memory (LSTM)</a>.
    </li>
</ul>
</div></section>
<section id="libraries">
<h2>Libraries<a class="headerlink" href="#libraries" title="Link to this heading">#</a></h2>
<div class="admonition note" name="html-admonition" style="background: rgba(0,191,191,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #00bfa5; border-color: #00bfa5; padding-left: 10px; padding-right: 10px;">
<p class="title">
    <i style="font-size: 18px; color:#00bfa5;"></i>
    <b style="color: #00bfa5;">&#128161 Tip: Configuring your backend</b>
</p>
<p>As of Skforecast version <code>0.13.0</code>, PyTorch backend support is available. You can configure the backend by exporting the <code>KERAS_BACKEND</code> environment variable or by editing your local configuration file at <code>~/.keras/keras.json</code>. The available backend options are: “tensorflow” and “torch”. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;KERAS_BACKEND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;torch&quot;</span>
<span class="kn">import</span> <span class="nn">keras</span>
</pre></div>
</div>
</div><div class="admonition note" name="html-admonition" style="background: rgba(255,145,0,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #ff9100; border-color: #ff9100; padding-left: 10px; padding-right: 10px">
<p class="title">
    <i style="font-size: 18px; color:#ff9100; border-color: #ff1744;"></i>
    <b style="color: #ff9100;"> <span style="color: #ff9100;">&#9888;</span> Warning</b>
</p>
<p>Note: The backend must be configured before importing Keras, and the backend cannot be changed after the package has been imported.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Libraries</span>
<span class="c1"># ==============================================================================</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;KERAS_BACKEND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tensorflow&quot;</span> <span class="c1"># &#39;tensorflow&#39;, &#39;jax´ or &#39;torch&#39;</span>
<span class="kn">import</span> <span class="nn">keras</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="kn">import</span> <span class="nn">skforecast</span>
<span class="kn">from</span> <span class="nn">skforecast.datasets</span> <span class="kn">import</span> <span class="n">fetch_dataset</span>
<span class="kn">from</span> <span class="nn">skforecast.plot</span> <span class="kn">import</span> <span class="n">set_dark_theme</span>
<span class="kn">from</span> <span class="nn">skforecast.ForecasterRnn</span> <span class="kn">import</span> <span class="n">ForecasterRnn</span>
<span class="kn">from</span> <span class="nn">skforecast.ForecasterRnn.utils</span> <span class="kn">import</span> <span class="n">create_and_compile_model</span>
<span class="kn">from</span> <span class="nn">skforecast.model_selection_multiseries</span> <span class="kn">import</span> <span class="n">backtesting_forecaster_multiseries</span>

<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">keras.losses</span> <span class="kn">import</span> <span class="n">MeanSquaredError</span>
<span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;once&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skforecast version: </span><span class="si">{</span><span class="n">skforecast</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;keras version: </span><span class="si">{</span><span class="n">keras</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;</span> <span class="s2">&quot;3.0&quot;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using backend: </span><span class="si">{</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tensorflow&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tensorflow version: </span><span class="si">{</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">torch</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;torch version: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backend not recognized. Please use &#39;tensorflow&#39; or &#39;torch&#39;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;KERAS_BACKEND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tensorflow&quot;</span> <span class="c1"># &#39;tensorflow&#39;, &#39;jax´ or &#39;torch&#39;</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="kn">import</span> <span class="nn">keras</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;keras&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data download</span>
<span class="c1"># ==============================================================================</span>
<span class="n">air_quality</span> <span class="o">=</span> <span class="n">fetch_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;air_quality_valencia&quot;</span><span class="p">)</span>

<span class="c1"># Data preparation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">air_quality</span> <span class="o">=</span> <span class="n">air_quality</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
<span class="n">air_quality</span> <span class="o">=</span> <span class="n">air_quality</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">air_quality</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>air_quality_valencia
--------------------
Hourly measures of several air chemical pollutant (pm2.5, co, no, no2, pm10,
nox, o3, so2) at Valencia city.
 Red de Vigilancia y Control de la Contaminación Atmosférica, 46250054-València
- Centre, https://mediambient.gva.es/es/web/calidad-ambiental/datos-historicos.
Shape of the dataset: (26304, 10)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pm2.5</th>
      <th>co</th>
      <th>no</th>
      <th>no2</th>
      <th>pm10</th>
      <th>nox</th>
      <th>o3</th>
      <th>veloc.</th>
      <th>direc.</th>
      <th>so2</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2019-01-01 00:00:00</th>
      <td>19.0</td>
      <td>0.2</td>
      <td>3.0</td>
      <td>36.0</td>
      <td>22.0</td>
      <td>40.0</td>
      <td>16.0</td>
      <td>0.5</td>
      <td>262.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>2019-01-01 01:00:00</th>
      <td>26.0</td>
      <td>0.1</td>
      <td>2.0</td>
      <td>40.0</td>
      <td>32.0</td>
      <td>44.0</td>
      <td>6.0</td>
      <td>0.6</td>
      <td>248.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>2019-01-01 02:00:00</th>
      <td>31.0</td>
      <td>0.1</td>
      <td>11.0</td>
      <td>42.0</td>
      <td>36.0</td>
      <td>58.0</td>
      <td>3.0</td>
      <td>0.3</td>
      <td>224.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>2019-01-01 03:00:00</th>
      <td>30.0</td>
      <td>0.1</td>
      <td>15.0</td>
      <td>41.0</td>
      <td>35.0</td>
      <td>63.0</td>
      <td>3.0</td>
      <td>0.2</td>
      <td>220.0</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>2019-01-01 04:00:00</th>
      <td>30.0</td>
      <td>0.1</td>
      <td>16.0</td>
      <td>39.0</td>
      <td>36.0</td>
      <td>63.0</td>
      <td>3.0</td>
      <td>0.4</td>
      <td>221.0</td>
      <td>11.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Checking the frequency of the time series</span>
<span class="c1"># ==============================================================================</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index: </span><span class="si">{</span><span class="n">air_quality</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frequency: </span><span class="si">{</span><span class="n">air_quality</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">freq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index: datetime64[ns]
Frequency: &lt;Hour&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split train-validation-test</span>
<span class="c1"># ==============================================================================</span>
<span class="n">end_train</span> <span class="o">=</span> <span class="s2">&quot;2021-03-31 23:59:00&quot;</span>
<span class="n">end_validation</span> <span class="o">=</span> <span class="s2">&quot;2021-09-30 23:59:00&quot;</span>
<span class="n">air_quality_train</span> <span class="o">=</span> <span class="n">air_quality</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_train</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">air_quality_val</span> <span class="o">=</span> <span class="n">air_quality</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_train</span><span class="p">:</span><span class="n">end_validation</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">air_quality_test</span> <span class="o">=</span> <span class="n">air_quality</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">end_validation</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Dates train      : </span><span class="si">{</span><span class="n">air_quality_train</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> --- &quot;</span> 
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">air_quality_train</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">  (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">air_quality_train</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Dates validation : </span><span class="si">{</span><span class="n">air_quality_val</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> --- &quot;</span> 
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">air_quality_val</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">  (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">air_quality_val</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Dates test       : </span><span class="si">{</span><span class="n">air_quality_test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> --- &quot;</span> 
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">air_quality_test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">  (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">air_quality_test</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dates train      : 2019-01-01 00:00:00 --- 2021-03-31 23:00:00  (n=19704)
Dates validation : 2021-04-01 00:00:00 --- 2021-09-30 23:00:00  (n=4392)
Dates test       : 2021-10-01 00:00:00 --- 2021-12-31 23:00:00  (n=2208)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting one feature</span>
<span class="c1"># ==============================================================================</span>
<span class="n">set_dark_theme</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">air_quality_train</span><span class="p">[</span><span class="s2">&quot;pm2.5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">air_quality_val</span><span class="p">[</span><span class="s2">&quot;pm2.5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
<span class="n">air_quality_test</span><span class="p">[</span><span class="s2">&quot;pm2.5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;pm2.5&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ec09e4edf1d18677c2fee02ce6f9a6bc677786028a8c6c848b3093cea57f0261.png" src="../_images/ec09e4edf1d18677c2fee02ce6f9a6bc677786028a8c6c848b3093cea57f0261.png" />
</div>
</div>
</section>
<section id="types-of-problems-in-time-series-modeling">
<h2>Types of problems in time series modeling<a class="headerlink" href="#types-of-problems-in-time-series-modeling" title="Link to this heading">#</a></h2>
<section id="single-step-forecasting-predict-one-step-ahead-of-a-single-series-using-the-same-series-as-predictor">
<h3>1:1 Single-Step Forecasting - Predict one step ahead of a single series using the same series as predictor.<a class="headerlink" href="#single-step-forecasting-predict-one-step-ahead-of-a-single-series-using-the-same-series-as-predictor" title="Link to this heading">#</a></h3>
<p>This type of problem involves modeling a time series using only its own past. It is a typical autoregressive problem.</p>
<p>Although tensorflow-keras facilitates the process of creating <em>deep learning</em> architectures, it is not always trivial to determine the Xtrain and Ytrain dimensions requiered to run an LSTM model. The dimensions depend on how many time series are being modeled, how many of them are are used as predictors, and the length of the prediction horizon.</p>
<div class="admonition note" name="html-admonition" style="background: rgba(0,184,212,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #00b8d4; border-color: #00b8d4; padding-left: 10px; padding-right: 10px;">
<p class="title">
    <i style="font-size: 18px; color:#00b8d4;"></i>
    <b style="color: #00b8d4;">&#9998 Note</b>
</p>
<p>The <code class="docutils literal notranslate"><span class="pre">create_and_compile_model</span></code> function is designed to facilitate the creation of the Tensorflow model. Advanced users can create their own architectures and pass them to the skforecast RNN Forecaster. Input and output dimensions must match the use case to which the model will be applied. the Annex at the end of the document for more details.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create model</span>
<span class="c1"># ==============================================================================</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Series used as predictors</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Target serie to predict</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># Past time steps to be used to predict the target</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Future time steps to be predicted</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.6.0
Using backend: tensorflow
tensorflow version: 2.17.0
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)          │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                     │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">4</span>)              │            <span style="color: #00af00; text-decoration-color: #00af00">96</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">16</span>)             │            <span style="color: #00af00; text-decoration-color: #00af00">80</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)              │            <span style="color: #00af00; text-decoration-color: #00af00">17</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">193</span> (772.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">193</span> (772.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Forecaster Definition</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span> <span class="o">=</span> <span class="n">ForecasterRnn</span><span class="p">(</span>
    <span class="n">regressor</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">transformer_series</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">(),</span>
    <span class="n">fit_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Number of epochs to train the model.</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># Batch size to train the model.</span>
        <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># Callback to stop training when it is no longer learning.</span>
        <span class="s2">&quot;series_val&quot;</span><span class="p">:</span> <span class="n">data_val</span><span class="p">,</span>  <span class="c1"># Validation data for model training.</span>
    <span class="p">},</span>
<span class="p">)</span>    

<span class="n">forecaster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/env/lib/python3.10/site-packages/skforecast/ForecasterRnn/ForecasterRnn.py:229: UserWarning: Setting `lags` = &#39;auto&#39;. `lags` are inferred from the regressor architecture. Avoid the warning with lags=lags.
  warnings.warn(
/env/lib/python3.10/site-packages/skforecast/ForecasterRnn/ForecasterRnn.py:265: UserWarning: `steps` default value = &#39;auto&#39;. `steps` inferred from regressor architecture. Avoid the warning with steps=steps.
  warnings.warn(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============= 
ForecasterRnn 
============= 
Regressor: &lt;Functional name=functional, built=True&gt; 
Lags: [ 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24
 25 26 27 28 29 30 31 32] 
Transformer for series: MinMaxScaler() 
Window size: 32 
Target series, levels: [&#39;o3&#39;] 
Multivariate series (names): None 
Maximum steps predicted: [1] 
Training range: None 
Training index type: None 
Training index frequency: None 
Model parameters: {&#39;name&#39;: &#39;functional&#39;, &#39;trainable&#39;: True, &#39;layers&#39;: [{&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;InputLayer&#39;, &#39;config&#39;: {&#39;batch_shape&#39;: (None, 32, 1), &#39;dtype&#39;: &#39;float32&#39;, &#39;sparse&#39;: False, &#39;name&#39;: &#39;input_layer&#39;}, &#39;registered_name&#39;: None, &#39;name&#39;: &#39;input_layer&#39;, &#39;inbound_nodes&#39;: []}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: False, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 4, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;seed&#39;: None, &#39;gain&#39;: 1.0}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32, 1)}, &#39;name&#39;: &#39;lstm&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32, 1), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;input_layer&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 16, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 4)}, &#39;name&#39;: &#39;dense&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 4), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_1&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 1, &#39;activation&#39;: &#39;linear&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 16)}, &#39;name&#39;: &#39;dense_1&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 16), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Reshape&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;reshape&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;target_shape&#39;: (1, 1)}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 1)}, &#39;name&#39;: &#39;reshape&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 1), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_1&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}], &#39;input_layers&#39;: [[&#39;input_layer&#39;, 0, 0]], &#39;output_layers&#39;: [[&#39;reshape&#39;, 0, 0]]} 
Compile parameters: {&#39;optimizer&#39;: {&#39;module&#39;: &#39;keras.optimizers&#39;, &#39;class_name&#39;: &#39;Adam&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;adam&#39;, &#39;learning_rate&#39;: 0.009999999776482582, &#39;weight_decay&#39;: None, &#39;clipnorm&#39;: None, &#39;global_clipnorm&#39;: None, &#39;clipvalue&#39;: None, &#39;use_ema&#39;: False, &#39;ema_momentum&#39;: 0.99, &#39;ema_overwrite_frequency&#39;: None, &#39;loss_scale_factor&#39;: None, &#39;gradient_accumulation_steps&#39;: None, &#39;beta_1&#39;: 0.9, &#39;beta_2&#39;: 0.999, &#39;epsilon&#39;: 1e-07, &#39;amsgrad&#39;: False}, &#39;registered_name&#39;: None}, &#39;loss&#39;: {&#39;module&#39;: &#39;keras.losses&#39;, &#39;class_name&#39;: &#39;MeanSquaredError&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;mean_squared_error&#39;, &#39;reduction&#39;: &#39;sum_over_batch_size&#39;}, &#39;registered_name&#39;: None}, &#39;loss_weights&#39;: None, &#39;metrics&#39;: None, &#39;weighted_metrics&#39;: None, &#39;run_eagerly&#39;: False, &#39;steps_per_execution&#39;: 1, &#39;jit_compile&#39;: False} 
fit_kwargs: {&#39;epochs&#39;: 3, &#39;batch_size&#39;: 32, &#39;callbacks&#39;: [&lt;keras.src.callbacks.early_stopping.EarlyStopping object at 0x7f073c2fc400&gt;]} 
Creation date: 2024-10-22 22:46:04 
Last fit date: None 
Skforecast version: 0.13.0 
Python version: 3.10.15 
Forecaster id: None 
</pre></div>
</div>
</div>
</div>
<div class="admonition note" name="html-admonition" style="background: rgba(255,145,0,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #ff9100; border-color: #ff9100; padding-left: 10px; padding-right: 10px">
<p class="title">
    <i style="font-size: 18px; color:#ff9100; border-color: #ff1744;"></i>
    <b style="color: #ff9100;"> <span style="color: #ff9100;">&#9888;</span> Warning</b>
</p>
<p>The output warning indicates that the number of lags has been inferred from the model architecture. In this case, the model has an LSTM layer with 32 neurons, so the number of lags is 32. If a different number of lags is desired, the <code class="docutils literal notranslate"><span class="pre">lags</span></code> argument can be specified in the <code class="docutils literal notranslate"><span class="pre">create_and_compile_model</span></code> function.
To omit the warning, set <code class="docutils literal notranslate"><span class="pre">lags=lags</span></code> and <code class="docutils literal notranslate"><span class="pre">steps=steps</span></code> arguments can be specified in the initialization of the <code class="docutils literal notranslate"><span class="pre">ForecasterRnn</span></code>.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit forecaster</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">7s</span> 9ms/step - loss: 0.0191 - val_loss: 0.0059
Epoch 2/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">5s</span> 8ms/step - loss: 0.0057 - val_loss: 0.0058
Epoch 3/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">5s</span> 8ms/step - loss: 0.0057 - val_loss: 0.0058
</pre></div>
</div>
</div>
</div>
<p>Overfitting can be tracked by moniting the loss function on the validation set. Metrics are automatically stored in the <code class="docutils literal notranslate"><span class="pre">history</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">ForecasterRnn</span></code> object. The method <code class="docutils literal notranslate"><span class="pre">plot_history</span></code> can be used to visualize the training and validation loss.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Track training and overfitting</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">plot_history</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/01dab7438a34b722b90ce9255552a3243d6f60397c3de2f96d4fc7dfe7ba35d7.png" src="../_images/01dab7438a34b722b90ce9255552a3243d6f60397c3de2f96d4fc7dfe7ba35d7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01</th>
      <td>49.872669</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting with test data</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">backtesting_forecaster_multiseries</span><span class="p">(</span>
    <span class="n">forecaster</span><span class="o">=</span><span class="n">forecaster</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">initial_train_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_validation</span><span class="p">,</span> <span class="p">:]),</span> <span class="c1"># Training + Validation Data</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># Set to True to print detailed information</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">6s</span> 7ms/step - loss: 0.0057 - val_loss: 0.0063
Epoch 2/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">5s</span> 6ms/step - loss: 0.0054 - val_loss: 0.0059
Epoch 3/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">5s</span> 6ms/step - loss: 0.0055 - val_loss: 0.0057
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "af9bb4d66dd64b9ca238f7dbb6e7dd37", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-10-01 00:00:00</th>
      <td>55.153450</td>
    </tr>
    <tr>
      <th>2021-10-01 01:00:00</th>
      <td>59.825748</td>
    </tr>
    <tr>
      <th>2021-10-01 02:00:00</th>
      <td>63.543854</td>
    </tr>
    <tr>
      <th>2021-10-01 03:00:00</th>
      <td>63.651814</td>
    </tr>
    <tr>
      <th>2021-10-01 04:00:00</th>
      <td>54.029079</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-31 19:00:00</th>
      <td>19.551771</td>
    </tr>
    <tr>
      <th>2021-12-31 20:00:00</th>
      <td>16.370989</td>
    </tr>
    <tr>
      <th>2021-12-31 21:00:00</th>
      <td>17.101360</td>
    </tr>
    <tr>
      <th>2021-12-31 22:00:00</th>
      <td>17.049608</td>
    </tr>
    <tr>
      <th>2021-12-31 23:00:00</th>
      <td>18.086975</td>
    </tr>
  </tbody>
</table>
<p>2208 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># % Error vs series mean</span>
<span class="c1"># ==============================================================================</span>
<span class="n">rel_mse</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serie mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;o3&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative error (mae): </span><span class="si">{</span><span class="n">rel_mse</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Serie mean: 54.52
Relative error (mae): 11.04 %
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting predictions vs real values in the test set</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">data_test</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;O3&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d31aaf4560b45a69da1337c4167c1c5429fa6185fb822cf30c74ce94e2064dfc.png" src="../_images/d31aaf4560b45a69da1337c4167c1c5429fa6185fb822cf30c74ce94e2064dfc.png" />
</div>
</div>
</section>
<section id="multiple-step-forecasting-predict-a-single-series-using-the-same-series-as-predictor-multiple-steps-ahead">
<h3>1:1 Multiple-Step Forecasting - Predict a single series using the same series as predictor. Multiple steps ahead.<a class="headerlink" href="#multiple-step-forecasting-predict-a-single-series-using-the-same-series-as-predictor-multiple-steps-ahead" title="Link to this heading">#</a></h3>
<p>The next case is similar to the previous one, but now the goal is to predict multiple future values. In this scenario multiple future steps of a single time series are modeled using only its past values.</p>
<p>A similar architecture to the previous one will be used, but with a greater number of neurons in the LSTM layer and in the first dense layer. This will allow the model to have greater flexibility to predict the time series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model creation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Series used as predictors</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Target serie to predict</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># Past time steps to be used to predict the target</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Future time steps to be predicted</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.6.0
Using backend: tensorflow
tensorflow version: 2.17.0
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional_1"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)          │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">50</span>)             │        <span style="color: #00af00; text-decoration-color: #00af00">10,400</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">1,632</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>)              │           <span style="color: #00af00; text-decoration-color: #00af00">165</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">12,197</span> (47.64 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">12,197</span> (47.64 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_val</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>36.0</td>
    </tr>
    <tr>
      <th>2021-04-01 01:00:00</th>
      <td>20.0</td>
    </tr>
    <tr>
      <th>2021-04-01 02:00:00</th>
      <td>18.0</td>
    </tr>
    <tr>
      <th>2021-04-01 03:00:00</th>
      <td>24.0</td>
    </tr>
    <tr>
      <th>2021-04-01 04:00:00</th>
      <td>22.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-09-30 19:00:00</th>
      <td>78.0</td>
    </tr>
    <tr>
      <th>2021-09-30 20:00:00</th>
      <td>76.0</td>
    </tr>
    <tr>
      <th>2021-09-30 21:00:00</th>
      <td>63.0</td>
    </tr>
    <tr>
      <th>2021-09-30 22:00:00</th>
      <td>60.0</td>
    </tr>
    <tr>
      <th>2021-09-30 23:00:00</th>
      <td>56.0</td>
    </tr>
  </tbody>
</table>
<p>4392 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Forecaster Creation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span> <span class="o">=</span> <span class="n">ForecasterRnn</span><span class="p">(</span>
    <span class="n">regressor</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">transformer_series</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">(),</span>
    <span class="n">fit_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Number of epochs to train the model.</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>  <span class="c1"># Batch size to train the model.</span>
        <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">],</span>  <span class="c1"># Callback to stop training when it is no longer learning.</span>
        <span class="s2">&quot;series_val&quot;</span><span class="p">:</span> <span class="n">data_val</span><span class="p">,</span>  <span class="c1"># Validation data for model training.</span>
    <span class="p">},</span>
<span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/env/lib/python3.10/site-packages/skforecast/ForecasterRnn/ForecasterRnn.py:229: UserWarning: Setting `lags` = &#39;auto&#39;. `lags` are inferred from the regressor architecture. Avoid the warning with lags=lags.
  warnings.warn(
/env/lib/python3.10/site-packages/skforecast/ForecasterRnn/ForecasterRnn.py:265: UserWarning: `steps` default value = &#39;auto&#39;. `steps` inferred from regressor architecture. Avoid the warning with steps=steps.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<div class="admonition note" name="html-admonition" style="background: rgba(0,184,212,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #00b8d4; border-color: #00b8d4; padding-left: 10px; padding-right: 10px;">
<p class="title">
    <i style="font-size: 18px; color:#00b8d4;"></i>
    <b style="color: #00b8d4;">&#9998 Note</b>
</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fit_kwargs</span></code> parameter allows the user to set any Tensorflow-based configuration in the model. In the example, 10 training epochs are defined with a batch size of 32. An <code class="docutils literal notranslate"><span class="pre">EarlyStopping</span></code> callback is configured to stop training when the validation loss stops decreasing for 5 epochs (<code class="docutils literal notranslate"><span class="pre">patience=5</span></code>). Other callbacks can also be configured, such as <code class="docutils literal notranslate"><span class="pre">ModelCheckpoint</span></code> to save the model at each epoch, or even Tensorboard to visualize the training and validation loss in real time.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit forecaster</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">12s</span> 17ms/step - loss: 0.0307 - val_loss: 0.0206
Epoch 2/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">10s</span> 16ms/step - loss: 0.0188 - val_loss: 0.0154
Epoch 3/3
<span class=" -Color -Color-Bold">615/615</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">10s</span> 16ms/step - loss: 0.0162 - val_loss: 0.0152
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train and overfitting tracking</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">plot_history</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0ef0742b0b99ab3b93ca4cac873ae969ccab0d0d22e57b017df49e83e2cfc793.png" src="../_images/0ef0742b0b99ab3b93ca4cac873ae969ccab0d0d22e57b017df49e83e2cfc793.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prediction</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>43.579914</td>
    </tr>
    <tr>
      <th>2021-04-01 01:00:00</th>
      <td>43.036030</td>
    </tr>
    <tr>
      <th>2021-04-01 02:00:00</th>
      <td>38.125568</td>
    </tr>
    <tr>
      <th>2021-04-01 03:00:00</th>
      <td>35.505390</td>
    </tr>
    <tr>
      <th>2021-04-01 04:00:00</th>
      <td>37.147205</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specific step predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>43.579914</td>
    </tr>
    <tr>
      <th>2021-04-01 02:00:00</th>
      <td>38.125568</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting </span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">backtesting_forecaster_multiseries</span><span class="p">(</span>
    <span class="n">forecaster</span><span class="o">=</span><span class="n">forecaster</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">initial_train_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_validation</span><span class="p">,</span> <span class="p">:]),</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">41s</span> 54ms/step - loss: 0.0121 - val_loss: 0.0115
Epoch 2/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">41s</span> 55ms/step - loss: 0.0119 - val_loss: 0.0120
Epoch 3/3
<span class=" -Color -Color-Bold">752/752</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">46s</span> 61ms/step - loss: 0.0116 - val_loss: 0.0114
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1d3ec3102d454ed8ac4c1a0ada8c0075", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-10-01 00:00:00</th>
      <td>57.922863</td>
    </tr>
    <tr>
      <th>2021-10-01 01:00:00</th>
      <td>55.142830</td>
    </tr>
    <tr>
      <th>2021-10-01 02:00:00</th>
      <td>53.163837</td>
    </tr>
    <tr>
      <th>2021-10-01 03:00:00</th>
      <td>50.351650</td>
    </tr>
    <tr>
      <th>2021-10-01 04:00:00</th>
      <td>48.197075</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-31 19:00:00</th>
      <td>21.249779</td>
    </tr>
    <tr>
      <th>2021-12-31 20:00:00</th>
      <td>23.083706</td>
    </tr>
    <tr>
      <th>2021-12-31 21:00:00</th>
      <td>18.573345</td>
    </tr>
    <tr>
      <th>2021-12-31 22:00:00</th>
      <td>16.224133</td>
    </tr>
    <tr>
      <th>2021-12-31 23:00:00</th>
      <td>16.216816</td>
    </tr>
  </tbody>
</table>
<p>2208 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting predictions vs real values in the test set</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">data_test</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;O3&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4f904d995c3263ece6e7fbf6a45a3ab234e25a05cd279b660e460630ca19a9bc.png" src="../_images/4f904d995c3263ece6e7fbf6a45a3ab234e25a05cd279b660e460630ca19a9bc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting metrics</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>levels</th>
      <th>mean_absolute_error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>o3</td>
      <td>9.561174</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># % Error vs series mean</span>
<span class="c1"># ==============================================================================</span>
<span class="n">rel_mse</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serie mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;o3&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative error (mae): </span><span class="si">{</span><span class="n">rel_mse</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Serie mean: 54.52
Relative error (mae): 17.54 %
</pre></div>
</div>
</div>
</div>
</section>
<section id="n-1-multiple-step-forecasting-predict-one-series-using-multiple-series-as-predictors">
<h3>N:1 Multiple-Step Forecasting - Predict one series using multiple series as predictors.<a class="headerlink" href="#n-1-multiple-step-forecasting-predict-one-series-using-multiple-series-as-predictors" title="Link to this heading">#</a></h3>
<p>In this case, a single series will be predicted, but using multiple time series as predictors. Now, the past values of multiple time series will influence the prediction of a single time series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model creation</span>
<span class="c1"># ==============================================================================</span>
<span class="c1"># Time series used in the training. Now, it is multiseries</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;no2&#39;</span><span class="p">,</span> <span class="s1">&#39;pm10&#39;</span><span class="p">,</span> <span class="s1">&#39;nox&#39;</span><span class="p">,</span> <span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="s1">&#39;veloc.&#39;</span><span class="p">,</span> <span class="s1">&#39;direc.&#39;</span><span class="p">,</span><span class="s1">&#39;so2&#39;</span><span class="p">]</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> 
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> 
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5</span> 

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.4.1
Using backend: torch
torch version: 2.2.2+cpu
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional_2"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">10</span>)         │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">100</span>)        │        <span style="color: #00af00; text-decoration-color: #00af00">44,400</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">50</span>)             │        <span style="color: #00af00; text-decoration-color: #00af00">30,200</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_4 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">3,264</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">2,080</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_6 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>)              │           <span style="color: #00af00; text-decoration-color: #00af00">165</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,109</span> (312.93 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,109</span> (312.93 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Forecaster creation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span> <span class="o">=</span> <span class="n">ForecasterRnn</span><span class="p">(</span>
    <span class="n">regressor</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">transformer_series</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">(),</span>
    <span class="n">fit_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>  
        <span class="s2">&quot;series_val&quot;</span><span class="p">:</span> <span class="n">data_val</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">forecaster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============= 
ForecasterRnn 
============= 
Regressor: &lt;Functional name=functional_2, built=True&gt; 
Lags: [ 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24
 25 26 27 28 29 30 31 32] 
Transformer for series: MinMaxScaler() 
Window size: 32 
Target series, levels: [&#39;o3&#39;] 
Multivariate series (names): None 
Maximum steps predicted: [1 2 3 4 5] 
Training range: None 
Training index type: None 
Training index frequency: None 
Model parameters: {&#39;name&#39;: &#39;functional_2&#39;, &#39;trainable&#39;: True, &#39;layers&#39;: [{&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;InputLayer&#39;, &#39;config&#39;: {&#39;batch_shape&#39;: (None, 32, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;sparse&#39;: False, &#39;name&#39;: &#39;input_layer_2&#39;}, &#39;registered_name&#39;: None, &#39;name&#39;: &#39;input_layer_2&#39;, &#39;inbound_nodes&#39;: []}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_2&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: True, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 100, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32, 10)}, &#39;name&#39;: &#39;lstm_2&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;input_layer_2&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_3&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: False, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 50, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32, 100)}, &#39;name&#39;: &#39;lstm_3&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32, 100), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_2&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_4&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 64, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 50)}, &#39;name&#39;: &#39;dense_4&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 50), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_3&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_5&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 32, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 64)}, &#39;name&#39;: &#39;dense_5&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 64), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_4&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_6&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 5, &#39;activation&#39;: &#39;linear&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32)}, &#39;name&#39;: &#39;dense_6&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_5&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Reshape&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;reshape_2&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;target_shape&#39;: (5, 1)}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 5)}, &#39;name&#39;: &#39;reshape_2&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 5), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_6&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}], &#39;input_layers&#39;: [[&#39;input_layer_2&#39;, 0, 0]], &#39;output_layers&#39;: [[&#39;reshape_2&#39;, 0, 0]]} 
Compile parameters: {&#39;optimizer&#39;: {&#39;module&#39;: &#39;keras.src.backend.torch.optimizers.torch_adam&#39;, &#39;class_name&#39;: &#39;Adam&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;adam&#39;, &#39;learning_rate&#39;: 0.009999999776482582, &#39;weight_decay&#39;: None, &#39;clipnorm&#39;: None, &#39;global_clipnorm&#39;: None, &#39;clipvalue&#39;: None, &#39;use_ema&#39;: False, &#39;ema_momentum&#39;: 0.99, &#39;ema_overwrite_frequency&#39;: None, &#39;loss_scale_factor&#39;: None, &#39;gradient_accumulation_steps&#39;: None, &#39;beta_1&#39;: 0.9, &#39;beta_2&#39;: 0.999, &#39;epsilon&#39;: 1e-07, &#39;amsgrad&#39;: False}, &#39;registered_name&#39;: &#39;Adam&#39;}, &#39;loss&#39;: {&#39;module&#39;: &#39;keras.losses&#39;, &#39;class_name&#39;: &#39;MeanSquaredError&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;mean_squared_error&#39;, &#39;reduction&#39;: &#39;sum_over_batch_size&#39;}, &#39;registered_name&#39;: None}, &#39;loss_weights&#39;: None, &#39;metrics&#39;: None, &#39;weighted_metrics&#39;: None, &#39;run_eagerly&#39;: False, &#39;steps_per_execution&#39;: 1, &#39;jit_compile&#39;: False} 
fit_kwargs: {&#39;epochs&#39;: 4, &#39;batch_size&#39;: 128} 
Creation date: 2024-07-30 13:12:37 
Last fit date: None 
Skforecast version: 0.13.0 
Python version: 3.11.5 
Forecaster id: None 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit forecaster</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/4
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">23s</span> 152ms/step - loss: 0.0470 - val_loss: 0.0178
Epoch 2/4
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">24s</span> 153ms/step - loss: 0.0134 - val_loss: 0.0122
Epoch 3/4
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">22s</span> 145ms/step - loss: 0.0110 - val_loss: 0.0127
Epoch 4/4
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">25s</span> 162ms/step - loss: 0.0100 - val_loss: 0.0127
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trainig and overfitting tracking</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">plot_history</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cfa39076fb781553b93fcecf163668374461817b0676ca50ce1796721cf6f823.png" src="../_images/cfa39076fb781553b93fcecf163668374461817b0676ca50ce1796721cf6f823.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prediction</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>43.277061</td>
    </tr>
    <tr>
      <th>2021-04-01 01:00:00</th>
      <td>40.084240</td>
    </tr>
    <tr>
      <th>2021-04-01 02:00:00</th>
      <td>37.378689</td>
    </tr>
    <tr>
      <th>2021-04-01 03:00:00</th>
      <td>34.141743</td>
    </tr>
    <tr>
      <th>2021-04-01 04:00:00</th>
      <td>30.391361</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting with test data</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">backtesting_forecaster_multiseries</span><span class="p">(</span>
    <span class="n">forecaster</span><span class="o">=</span><span class="n">forecaster</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">initial_train_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_validation</span><span class="p">,</span> <span class="p">:]),</span> <span class="c1"># Datos de entrenamiento + validación</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/4
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">30s</span> 157ms/step - loss: 0.0098 - val_loss: 0.0113
Epoch 2/4
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">28s</span> 150ms/step - loss: 0.0095 - val_loss: 0.0111
Epoch 3/4
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">30s</span> 159ms/step - loss: 0.0093 - val_loss: 0.0121
Epoch 4/4
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">34s</span> 182ms/step - loss: 0.0093 - val_loss: 0.0113
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e4b2e160bc3941d5a8650ebf0c3c170d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting metrics</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>levels</th>
      <th>mean_absolute_error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>o3</td>
      <td>10.363694</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># % Error vs series mean</span>
<span class="c1"># ==============================================================================</span>
<span class="n">rel_mse</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serie mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;o3&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative error (mae): </span><span class="si">{</span><span class="n">rel_mse</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Serie mean: 54.52
Relative error (mae): 19.01 %
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-10-01 00:00:00</th>
      <td>49.819893</td>
    </tr>
    <tr>
      <th>2021-10-01 01:00:00</th>
      <td>46.665585</td>
    </tr>
    <tr>
      <th>2021-10-01 02:00:00</th>
      <td>42.649746</td>
    </tr>
    <tr>
      <th>2021-10-01 03:00:00</th>
      <td>37.113007</td>
    </tr>
    <tr>
      <th>2021-10-01 04:00:00</th>
      <td>32.271500</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-12-31 19:00:00</th>
      <td>17.417406</td>
    </tr>
    <tr>
      <th>2021-12-31 20:00:00</th>
      <td>11.689775</td>
    </tr>
    <tr>
      <th>2021-12-31 21:00:00</th>
      <td>3.200252</td>
    </tr>
    <tr>
      <th>2021-12-31 22:00:00</th>
      <td>4.635203</td>
    </tr>
    <tr>
      <th>2021-12-31 23:00:00</th>
      <td>6.826915</td>
    </tr>
  </tbody>
</table>
<p>2208 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting predictions vs real values in the test set</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">data_test</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;O3&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0556c30af8cc28171d479034a0571f9405be608bdb66843fc357cbb688309400.png" src="../_images/0556c30af8cc28171d479034a0571f9405be608bdb66843fc357cbb688309400.png" />
</div>
</div>
</section>
<section id="n-m-multiple-step-forecasting-multiple-time-series-with-multiple-outputs">
<h3>N:M Multiple-Step Forecasting - Multiple time series with multiple outputs<a class="headerlink" href="#n-m-multiple-step-forecasting-multiple-time-series-with-multiple-outputs" title="Link to this heading">#</a></h3>
<p>This is a more complex scenario in which multiple time series are predicted using multiple time series as predictors. It is therefore a scenario in which multiple series are modeled simultaneously using a single model. This has special application in many real scenarios, such as the prediction of stock values for several companies based on the stock history, the price of energy and commodities. Or the case of forecasting multiple products in an online store, based on the sales of other products, the price of the products, etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model creation</span>
<span class="c1"># ==============================================================================</span>
<span class="c1"># Now, we have multiple series and multiple targets</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;no2&#39;</span><span class="p">,</span> <span class="s1">&#39;pm10&#39;</span><span class="p">,</span> <span class="s1">&#39;nox&#39;</span><span class="p">,</span> <span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="s1">&#39;veloc.&#39;</span><span class="p">,</span> <span class="s1">&#39;direc.&#39;</span><span class="p">,</span><span class="s1">&#39;so2&#39;</span><span class="p">]</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1">#  Features to predict. It can be all the series or less</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> 
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5</span> 

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.4.1
Using backend: torch
torch version: 2.2.2+cpu
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional_3"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">10</span>)         │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_4 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">100</span>)        │        <span style="color: #00af00; text-decoration-color: #00af00">44,400</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">50</span>)             │        <span style="color: #00af00; text-decoration-color: #00af00">30,200</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_7 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">3,264</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_8 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">2,080</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_9 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">20</span>)             │           <span style="color: #00af00; text-decoration-color: #00af00">660</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape_3 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>, <span style="color: #00af00; text-decoration-color: #00af00">4</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,604</span> (314.86 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,604</span> (314.86 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Forecaster creation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span> <span class="o">=</span> <span class="n">ForecasterRnn</span><span class="p">(</span>
    <span class="n">regressor</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">transformer_series</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">(),</span>
    <span class="n">fit_kwargs</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> 
        <span class="s2">&quot;callbacks&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">],</span>  
        <span class="s2">&quot;series_val&quot;</span><span class="p">:</span> <span class="n">data_val</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">forecaster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============= 
ForecasterRnn 
============= 
Regressor: &lt;Functional name=functional_3, built=True&gt; 
Lags: [ 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24
 25 26 27 28 29 30 31 32] 
Transformer for series: MinMaxScaler() 
Window size: 32 
Target series, levels: [&#39;pm2.5&#39;, &#39;co&#39;, &#39;no&#39;, &#39;o3&#39;] 
Multivariate series (names): None 
Maximum steps predicted: [1 2 3 4 5] 
Training range: None 
Training index type: None 
Training index frequency: None 
Model parameters: {&#39;name&#39;: &#39;functional_3&#39;, &#39;trainable&#39;: True, &#39;layers&#39;: [{&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;InputLayer&#39;, &#39;config&#39;: {&#39;batch_shape&#39;: (None, 32, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;sparse&#39;: False, &#39;name&#39;: &#39;input_layer_3&#39;}, &#39;registered_name&#39;: None, &#39;name&#39;: &#39;input_layer_3&#39;, &#39;inbound_nodes&#39;: []}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_4&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: True, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 100, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32, 10)}, &#39;name&#39;: &#39;lstm_4&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;input_layer_3&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_5&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: False, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 50, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32, 100)}, &#39;name&#39;: &#39;lstm_5&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32, 100), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_4&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_7&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 64, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 50)}, &#39;name&#39;: &#39;dense_7&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 50), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_5&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_8&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 32, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 64)}, &#39;name&#39;: &#39;dense_8&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 64), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_7&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_9&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 20, &#39;activation&#39;: &#39;linear&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32)}, &#39;name&#39;: &#39;dense_9&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_8&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Reshape&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;reshape_3&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;target_shape&#39;: (5, 4)}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 20)}, &#39;name&#39;: &#39;reshape_3&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 20), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_9&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}], &#39;input_layers&#39;: [[&#39;input_layer_3&#39;, 0, 0]], &#39;output_layers&#39;: [[&#39;reshape_3&#39;, 0, 0]]} 
Compile parameters: {&#39;optimizer&#39;: {&#39;module&#39;: &#39;keras.src.backend.torch.optimizers.torch_adam&#39;, &#39;class_name&#39;: &#39;Adam&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;adam&#39;, &#39;learning_rate&#39;: 0.009999999776482582, &#39;weight_decay&#39;: None, &#39;clipnorm&#39;: None, &#39;global_clipnorm&#39;: None, &#39;clipvalue&#39;: None, &#39;use_ema&#39;: False, &#39;ema_momentum&#39;: 0.99, &#39;ema_overwrite_frequency&#39;: None, &#39;loss_scale_factor&#39;: None, &#39;gradient_accumulation_steps&#39;: None, &#39;beta_1&#39;: 0.9, &#39;beta_2&#39;: 0.999, &#39;epsilon&#39;: 1e-07, &#39;amsgrad&#39;: False}, &#39;registered_name&#39;: &#39;Adam&#39;}, &#39;loss&#39;: {&#39;module&#39;: &#39;keras.losses&#39;, &#39;class_name&#39;: &#39;MeanSquaredError&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;mean_squared_error&#39;, &#39;reduction&#39;: &#39;sum_over_batch_size&#39;}, &#39;registered_name&#39;: None}, &#39;loss_weights&#39;: None, &#39;metrics&#39;: None, &#39;weighted_metrics&#39;: None, &#39;run_eagerly&#39;: False, &#39;steps_per_execution&#39;: 1, &#39;jit_compile&#39;: False} 
fit_kwargs: {&#39;epochs&#39;: 10, &#39;batch_size&#39;: 128, &#39;callbacks&#39;: [&lt;keras.src.callbacks.early_stopping.EarlyStopping object at 0x000002B51CA05910&gt;]} 
Creation date: 2024-07-30 13:16:58 
Last fit date: None 
Skforecast version: 0.13.0 
Python version: 3.11.5 
Forecaster id: None 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit forecaster</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">25s</span> 160ms/step - loss: 0.0138 - val_loss: 0.0100
Epoch 2/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">25s</span> 166ms/step - loss: 0.0050 - val_loss: 0.0094
Epoch 3/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">27s</span> 175ms/step - loss: 0.0043 - val_loss: 0.0084
Epoch 4/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">26s</span> 172ms/step - loss: 0.0038 - val_loss: 0.0076
Epoch 5/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">27s</span> 174ms/step - loss: 0.0036 - val_loss: 0.0073
Epoch 6/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">23s</span> 149ms/step - loss: 0.0035 - val_loss: 0.0072
Epoch 7/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">25s</span> 163ms/step - loss: 0.0034 - val_loss: 0.0076
Epoch 8/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">25s</span> 163ms/step - loss: 0.0034 - val_loss: 0.0069
Epoch 9/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">24s</span> 158ms/step - loss: 0.0033 - val_loss: 0.0069
Epoch 10/10
<span class=" -Color -Color-Bold">154/154</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">27s</span> 175ms/step - loss: 0.0032 - val_loss: 0.0073
</pre></div>
</div>
</div>
</div>
<p>The prediction can also be made for specific <code class="docutils literal notranslate"><span class="pre">steps</span></code>, as long as they are within the prediction horizon defined in the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specific step predictions</span>
<span class="c1"># ==============================================================================</span>
<span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="s2">&quot;o3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>36.963165</td>
    </tr>
    <tr>
      <th>2021-04-01 04:00:00</th>
      <td>24.514666</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prediction</span>
<span class="c1"># ==============================================================================</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
<span class="n">predictions</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pm2.5</th>
      <th>co</th>
      <th>no</th>
      <th>o3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-04-01 00:00:00</th>
      <td>14.250182</td>
      <td>0.114879</td>
      <td>1.290489</td>
      <td>36.963165</td>
    </tr>
    <tr>
      <th>2021-04-01 01:00:00</th>
      <td>14.238721</td>
      <td>0.102153</td>
      <td>1.658386</td>
      <td>34.069336</td>
    </tr>
    <tr>
      <th>2021-04-01 02:00:00</th>
      <td>14.098439</td>
      <td>0.116550</td>
      <td>0.644113</td>
      <td>30.392138</td>
    </tr>
    <tr>
      <th>2021-04-01 03:00:00</th>
      <td>13.381383</td>
      <td>0.113979</td>
      <td>1.317875</td>
      <td>25.742840</td>
    </tr>
    <tr>
      <th>2021-04-01 04:00:00</th>
      <td>13.152705</td>
      <td>0.117441</td>
      <td>1.632742</td>
      <td>24.514666</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting with test data</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">backtesting_forecaster_multiseries</span><span class="p">(</span>
    <span class="n">forecaster</span><span class="o">=</span><span class="n">forecaster</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">forecaster</span><span class="o">.</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">initial_train_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end_validation</span><span class="p">,</span> <span class="p">:]),</span>
    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mean_absolute_error&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">30s</span> 161ms/step - loss: 0.0030 - val_loss: 0.0066
Epoch 2/10
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">31s</span> 167ms/step - loss: 0.0030 - val_loss: 0.0067
Epoch 3/10
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">29s</span> 153ms/step - loss: 0.0030 - val_loss: 0.0067
Epoch 4/10
<span class=" -Color -Color-Bold">188/188</span> <span class=" -Color -Color-Green">━━━━━━━━━━━━━━━━━━━━</span> <span class=" -Color -Color-Bold">34s</span> 181ms/step - loss: 0.0029 - val_loss: 0.0067
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4445a95cc59e4d11a0ef8d6c065cae83", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backtesting metrics</span>
<span class="c1"># ==============================================================================</span>
<span class="n">metrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>levels</th>
      <th>mean_absolute_error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>pm2.5</td>
      <td>3.521863</td>
    </tr>
    <tr>
      <th>1</th>
      <td>co</td>
      <td>0.025072</td>
    </tr>
    <tr>
      <th>2</th>
      <td>no</td>
      <td>2.873905</td>
    </tr>
    <tr>
      <th>3</th>
      <td>o3</td>
      <td>11.518277</td>
    </tr>
    <tr>
      <th>4</th>
      <td>average</td>
      <td>4.484779</td>
    </tr>
    <tr>
      <th>5</th>
      <td>weighted_average</td>
      <td>4.484779</td>
    </tr>
    <tr>
      <th>6</th>
      <td>pooling</td>
      <td>4.484779</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot all the predicted variables as rows in the plot</span>
<span class="c1"># ==============================================================================</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">levels</span><span class="p">):</span>
    <span class="n">data_test</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">predictions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predictions&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8cf0acf5b7c4edbb3deb3fad6356cb147f434184a06e76a4d5916627f5e7a85b.png" src="../_images/8cf0acf5b7c4edbb3deb3fad6356cb147f434184a06e76a4d5916627f5e7a85b.png" />
</div>
</div>
</section>
</section>
<section id="create-and-compile-tensorflow-models">
<h2>Create and compile Tensorflow models<a class="headerlink" href="#create-and-compile-tensorflow-models" title="Link to this heading">#</a></h2>
<p>To improve the user experience and speed up the prototyping, development, and production process, skforecast has the <code class="docutils literal notranslate"><span class="pre">create_and_compile_model</span></code> function, with which, by indicating just a few arguments, the architecture is inferred and the model is created.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">series</span></code>: Time series to be used to train the model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">levels</span></code>: Time series to be predicted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lags</span></code>: Number of time steps to be used to predict the next value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steps</span></code>: Number of time steps to be predicted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recurrent_layer</span></code>: Type of recurrent layer to use. By default, an LSTM layer is used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recurrent_units</span></code>: Number of units in the recurrent layer. By default, 100 is used. If a list is passed, a recurrent layer will be created for each element in the list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dense_units</span></code>: Number of units in the dense layer. By default, 64 is used. If a list is passed, a dense layer will be created for each element in the list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optimizer</span></code>: Optimizer to use. By default, Adam with a learning rate of 0.01 is used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">loss</span></code>: Loss function to use. By default, Mean Squared Error is used.</p></li>
</ul>
<div class="admonition note" name="html-admonition" style="background: rgba(0,184,212,.1); padding-top: 0px; padding-bottom: 6px; border-radius: 8px; border-left: 8px solid #00b8d4; border-color: #00b8d4; padding-left: 10px; padding-right: 10px;">
<p class="title">
    <i style="font-size: 18px; color:#00b8d4;"></i>
    <b style="color: #00b8d4;">&#9998 Note</b>
</p>
<p>The following examples use <code>recurrent_layer=”LSTM”</code> but it is also possible to use <code>”RNN”</code> layers.</p>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create model</span>
<span class="c1"># ==============================================================================</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Series used as predictors</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1"># Target series to predict</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># Past time steps to be used to predict the target</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Future time steps to be predicted</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.4.1
Using backend: torch
torch version: 2.2.2+cpu
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional_4"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer_4 (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)          │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_6 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">4</span>)              │            <span style="color: #00af00; text-decoration-color: #00af00">96</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_10 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">16</span>)             │            <span style="color: #00af00; text-decoration-color: #00af00">80</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_11 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)              │            <span style="color: #00af00; text-decoration-color: #00af00">17</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape_4 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">193</span> (772.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">193</span> (772.00 B)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
<p>In this case, a simple LSTM network is used, with a single recurrent layer with 4 neurons and a hidden dense layer with 16 neurons. The following table shows a detailed description of each layer:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Layer</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Output Shape</p></th>
<th class="head"><p>Parameters</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Input Layer (InputLayer)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">InputLayer</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">32,</span> <span class="pre">1)</span></code></p></td>
<td><p>0</p></td>
<td><p>This is the input layer of the model. It receives sequences of length 32, corresponding to the number of lags with a dimension at each time step.</p></td>
</tr>
<tr class="row-odd"><td><p>LSTM Layer (Long Short-Term Memory)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">LSTM</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">4)</span></code></p></td>
<td><p>96</p></td>
<td><p>The LSTM layer is a long and short-term memory layer that processes the input sequence. It has 4 LSTM units and connects to the next layer.</p></td>
</tr>
<tr class="row-even"><td><p>First Dense Layer (Dense)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Dense</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">16)</span></code></p></td>
<td><p>80</p></td>
<td><p>This is a fully connected layer with 16 units and uses a default activation function (relu) in the provided architecture.</p></td>
</tr>
<tr class="row-odd"><td><p>Second Dense Layer (Dense)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Dense</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">1)</span></code></p></td>
<td><p>17</p></td>
<td><p>Another fully connected dense layer, this time with a single output unit. It also uses a default activation function.</p></td>
</tr>
<tr class="row-even"><td><p>Reshape Layer (Reshape)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">Reshape</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">1,</span> <span class="pre">1)</span></code></p></td>
<td><p>0</p></td>
<td><p>This layer reshapes the output of the previous dense layer to have a specific shape <code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">1,</span> <span class="pre">1)</span></code>. This layer is not strictly necessary, but is included to make the module generalizable to other multi-output forecasting problems. The dimension of this output layer is <code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">steps_to_predict_future,</span> <span class="pre">series_to_predict)</span></code>. In this case, <code class="docutils literal notranslate"><span class="pre">steps=1</span> <span class="pre">and</span> <span class="pre">levels=&quot;o3&quot;</span></code>, so the dimension is <code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">1,</span> <span class="pre">1)</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Total Parameters and Trainable</p></td>
<td><p>-</p></td>
<td><p>-</p></td>
<td><p>193</p></td>
<td><p>Total Parameters: 193, Trainable Parameters: 193, Non-Trainable Parameters: 0</p></td>
</tr>
</tbody>
</table>
</div>
<p>More complex models can be created including:</p>
<ul class="simple">
<li><p>Multiple series to be modeled (levels)</p></li>
<li><p>Multiple series to be used as predictors (series)</p></li>
<li><p>Multiple steps to be predicted (steps)</p></li>
<li><p>Multiple lags to be used as predictors (lags)</p></li>
<li><p>Multiple recurrent layers (recurrent_units)</p></li>
<li><p>Multiple dense layers (dense_units)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model creation</span>
<span class="c1"># ==============================================================================</span>
<span class="c1"># Now, we have multiple series and multiple targets</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;no2&#39;</span><span class="p">,</span> <span class="s1">&#39;pm10&#39;</span><span class="p">,</span> <span class="s1">&#39;nox&#39;</span><span class="p">,</span> <span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="s1">&#39;veloc.&#39;</span><span class="p">,</span> <span class="s1">&#39;direc.&#39;</span><span class="p">,</span><span class="s1">&#39;so2&#39;</span><span class="p">]</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1">#  Features to predict. It can be all the series or less</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">32</span> 
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5</span> 

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.4.1
Using backend: torch
torch version: 2.2.2+cpu
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "functional_5"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ input_layer_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">InputLayer</span>)      │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">10</span>)         │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_7 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>, <span style="color: #00af00; text-decoration-color: #00af00">100</span>)        │        <span style="color: #00af00; text-decoration-color: #00af00">44,400</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_8 (<span style="color: #0087ff; text-decoration-color: #0087ff">LSTM</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">50</span>)             │        <span style="color: #00af00; text-decoration-color: #00af00">30,200</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_12 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">3,264</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_13 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)             │         <span style="color: #00af00; text-decoration-color: #00af00">2,080</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_14 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">20</span>)             │           <span style="color: #00af00; text-decoration-color: #00af00">660</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ reshape_5 (<span style="color: #0087ff; text-decoration-color: #0087ff">Reshape</span>)             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">5</span>, <span style="color: #00af00; text-decoration-color: #00af00">4</span>)           │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,604</span> (314.86 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">80,604</span> (314.86 KB)
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">0</span> (0.00 B)
</pre>
</div></div>
</div>
</section>
<section id="get-training-and-test-matrices">
<h2>Get training and test matrices<a class="headerlink" href="#get-training-and-test-matrices" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Model creation</span>
<span class="c1"># ==============================================================================</span>
<span class="n">series</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;no2&#39;</span><span class="p">,</span> <span class="s1">&#39;pm10&#39;</span><span class="p">,</span> <span class="s1">&#39;nox&#39;</span><span class="p">,</span> <span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="s1">&#39;veloc.&#39;</span><span class="p">,</span> <span class="s1">&#39;direc.&#39;</span><span class="p">,</span><span class="s1">&#39;so2&#39;</span><span class="p">]</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pm2.5&#39;</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s2">&quot;o3&quot;</span><span class="p">]</span> <span class="c1">#  Features to predict. It can be all the series or less</span>
<span class="n">lags</span> <span class="o">=</span> <span class="mi">10</span> 
<span class="n">steps</span> <span class="o">=</span> <span class="mi">5</span> 

<span class="n">data</span> <span class="o">=</span> <span class="n">air_quality</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_train</span> <span class="o">=</span> <span class="n">air_quality_train</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_val</span> <span class="o">=</span> <span class="n">air_quality_val</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">air_quality_test</span><span class="p">[</span><span class="n">series</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">create_and_compile_model</span><span class="p">(</span>
    <span class="n">series</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> 
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">recurrent_layer</span><span class="o">=</span><span class="s2">&quot;LSTM&quot;</span><span class="p">,</span>
    <span class="n">recurrent_units</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
    <span class="n">dense_units</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> 
    <span class="n">loss</span><span class="o">=</span><span class="n">MeanSquaredError</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">forecaster</span> <span class="o">=</span> <span class="n">ForecasterRnn</span><span class="p">(</span>
    <span class="n">regressor</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">forecaster</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>keras version: 3.4.1
Using backend: torch
torch version: 2.2.2+cpu
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============= 
ForecasterRnn 
============= 
Regressor: &lt;Functional name=functional_6, built=True&gt; 
Lags: [ 1  2  3  4  5  6  7  8  9 10] 
Transformer for series: MinMaxScaler() 
Window size: 10 
Target series, levels: [&#39;pm2.5&#39;, &#39;co&#39;, &#39;no&#39;, &#39;o3&#39;] 
Multivariate series (names): None 
Maximum steps predicted: [1 2 3 4 5] 
Training range: None 
Training index type: None 
Training index frequency: None 
Model parameters: {&#39;name&#39;: &#39;functional_6&#39;, &#39;trainable&#39;: True, &#39;layers&#39;: [{&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;InputLayer&#39;, &#39;config&#39;: {&#39;batch_shape&#39;: (None, 10, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;sparse&#39;: False, &#39;name&#39;: &#39;input_layer_6&#39;}, &#39;registered_name&#39;: None, &#39;name&#39;: &#39;input_layer_6&#39;, &#39;inbound_nodes&#39;: []}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_9&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: True, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 100, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 10, 10)}, &#39;name&#39;: &#39;lstm_9&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 10, 10), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;input_layer_6&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;LSTM&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;lstm_10&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;return_sequences&#39;: False, &#39;return_state&#39;: False, &#39;go_backwards&#39;: False, &#39;stateful&#39;: False, &#39;unroll&#39;: False, &#39;zero_output_for_mask&#39;: False, &#39;units&#39;: 50, &#39;activation&#39;: &#39;relu&#39;, &#39;recurrent_activation&#39;: &#39;sigmoid&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;recurrent_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;OrthogonalInitializer&#39;, &#39;config&#39;: {&#39;gain&#39;: 1.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;unit_forget_bias&#39;: True, &#39;kernel_regularizer&#39;: None, &#39;recurrent_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;activity_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;recurrent_constraint&#39;: None, &#39;bias_constraint&#39;: None, &#39;dropout&#39;: 0.0, &#39;recurrent_dropout&#39;: 0.0, &#39;seed&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 10, 100)}, &#39;name&#39;: &#39;lstm_10&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 10, 100), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_9&#39;, 0, 0]}},), &#39;kwargs&#39;: {&#39;training&#39;: False, &#39;mask&#39;: None}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_15&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 64, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 50)}, &#39;name&#39;: &#39;dense_15&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 50), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;lstm_10&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_16&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 32, &#39;activation&#39;: &#39;relu&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 64)}, &#39;name&#39;: &#39;dense_16&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 64), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_15&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Dense&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;dense_17&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;units&#39;: 20, &#39;activation&#39;: &#39;linear&#39;, &#39;use_bias&#39;: True, &#39;kernel_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;GlorotUniform&#39;, &#39;config&#39;: {&#39;seed&#39;: None}, &#39;registered_name&#39;: None}, &#39;bias_initializer&#39;: {&#39;module&#39;: &#39;keras.initializers&#39;, &#39;class_name&#39;: &#39;Zeros&#39;, &#39;config&#39;: {}, &#39;registered_name&#39;: None}, &#39;kernel_regularizer&#39;: None, &#39;bias_regularizer&#39;: None, &#39;kernel_constraint&#39;: None, &#39;bias_constraint&#39;: None}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 32)}, &#39;name&#39;: &#39;dense_17&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 32), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_16&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}, {&#39;module&#39;: &#39;keras.layers&#39;, &#39;class_name&#39;: &#39;Reshape&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;reshape_6&#39;, &#39;trainable&#39;: True, &#39;dtype&#39;: {&#39;module&#39;: &#39;keras&#39;, &#39;class_name&#39;: &#39;DTypePolicy&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;float32&#39;}, &#39;registered_name&#39;: None}, &#39;target_shape&#39;: (5, 4)}, &#39;registered_name&#39;: None, &#39;build_config&#39;: {&#39;input_shape&#39;: (None, 20)}, &#39;name&#39;: &#39;reshape_6&#39;, &#39;inbound_nodes&#39;: [{&#39;args&#39;: ({&#39;class_name&#39;: &#39;__keras_tensor__&#39;, &#39;config&#39;: {&#39;shape&#39;: (None, 20), &#39;dtype&#39;: &#39;float32&#39;, &#39;keras_history&#39;: [&#39;dense_17&#39;, 0, 0]}},), &#39;kwargs&#39;: {}}]}], &#39;input_layers&#39;: [[&#39;input_layer_6&#39;, 0, 0]], &#39;output_layers&#39;: [[&#39;reshape_6&#39;, 0, 0]]} 
Compile parameters: {&#39;optimizer&#39;: {&#39;module&#39;: &#39;keras.src.backend.torch.optimizers.torch_adam&#39;, &#39;class_name&#39;: &#39;Adam&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;adam&#39;, &#39;learning_rate&#39;: 0.009999999776482582, &#39;weight_decay&#39;: None, &#39;clipnorm&#39;: None, &#39;global_clipnorm&#39;: None, &#39;clipvalue&#39;: None, &#39;use_ema&#39;: False, &#39;ema_momentum&#39;: 0.99, &#39;ema_overwrite_frequency&#39;: None, &#39;loss_scale_factor&#39;: None, &#39;gradient_accumulation_steps&#39;: None, &#39;beta_1&#39;: 0.9, &#39;beta_2&#39;: 0.999, &#39;epsilon&#39;: 1e-07, &#39;amsgrad&#39;: False}, &#39;registered_name&#39;: &#39;Adam&#39;}, &#39;loss&#39;: {&#39;module&#39;: &#39;keras.losses&#39;, &#39;class_name&#39;: &#39;MeanSquaredError&#39;, &#39;config&#39;: {&#39;name&#39;: &#39;mean_squared_error&#39;, &#39;reduction&#39;: &#39;sum_over_batch_size&#39;}, &#39;registered_name&#39;: None}, &#39;loss_weights&#39;: None, &#39;metrics&#39;: None, &#39;weighted_metrics&#39;: None, &#39;run_eagerly&#39;: False, &#39;steps_per_execution&#39;: 1, &#39;jit_compile&#39;: False} 
fit_kwargs: {} 
Creation date: 2024-07-30 13:24:02 
Last fit date: None 
Skforecast version: 0.13.0 
Python version: 3.11.5 
Forecaster id: None 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecaster</span><span class="o">.</span><span class="n">create_train_X_y</span><span class="p">(</span><span class="n">data_train</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;X_train&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;pm2.5&#39;, &#39;co&#39;, &#39;no&#39;, &#39;no2&#39;, &#39;pm10&#39;, &#39;nox&#39;, &#39;o3&#39;, &#39;veloc.&#39;, &#39;direc.&#39;, &#39;so2&#39;]
</pre></div>
</div>
</div>
</div>
<p>The RNN Forecaster can also be used to generate the X_train and y_train matrices that will be used to train the model. The <code class="docutils literal notranslate"><span class="pre">create_train_X_y</span></code> method allows the user to obtain the training and test matrices that will be used to train the model. The method return 3 elements: X_train, y_train, and dimension_information. The X_train matrix has dimensions <code class="docutils literal notranslate"><span class="pre">(n_samples,</span> <span class="pre">n_lags,</span> <span class="pre">n_series)</span></code>, while the y_train matrix has dimensions <code class="docutils literal notranslate"><span class="pre">(n_samples,</span> <span class="pre">n_steps,</span> <span class="pre">n_levels)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">dimension_info</span> <span class="o">=</span> <span class="n">forecaster</span><span class="o">.</span><span class="n">create_train_X_y</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y_train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((19690, 10, 10), (19690, 5, 4))
</pre></div>
</div>
</div>
</div>
<p>The dimension_information dictionary contains the information of each dimension value for both X_train and y_train.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;X_train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Timestamp(&#39;2019-01-01 10:00:00&#39;),
 Timestamp(&#39;2019-01-01 11:00:00&#39;),
 Timestamp(&#39;2019-01-01 12:00:00&#39;),
 Timestamp(&#39;2019-01-01 13:00:00&#39;),
 Timestamp(&#39;2019-01-01 14:00:00&#39;),
 Timestamp(&#39;2019-01-01 15:00:00&#39;),
 Timestamp(&#39;2019-01-01 16:00:00&#39;),
 Timestamp(&#39;2019-01-01 17:00:00&#39;),
 Timestamp(&#39;2019-01-01 18:00:00&#39;),
 Timestamp(&#39;2019-01-01 19:00:00&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;X_train&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;lag_1&#39;,
 &#39;lag_2&#39;,
 &#39;lag_3&#39;,
 &#39;lag_4&#39;,
 &#39;lag_5&#39;,
 &#39;lag_6&#39;,
 &#39;lag_7&#39;,
 &#39;lag_8&#39;,
 &#39;lag_9&#39;,
 &#39;lag_10&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;X_train&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;pm2.5&#39;, &#39;co&#39;, &#39;no&#39;, &#39;no2&#39;, &#39;pm10&#39;, &#39;nox&#39;, &#39;o3&#39;, &#39;veloc.&#39;, &#39;direc.&#39;, &#39;so2&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;y_train&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Timestamp(&#39;2019-01-01 10:00:00&#39;),
 Timestamp(&#39;2019-01-01 11:00:00&#39;),
 Timestamp(&#39;2019-01-01 12:00:00&#39;),
 Timestamp(&#39;2019-01-01 13:00:00&#39;),
 Timestamp(&#39;2019-01-01 14:00:00&#39;),
 Timestamp(&#39;2019-01-01 15:00:00&#39;),
 Timestamp(&#39;2019-01-01 16:00:00&#39;),
 Timestamp(&#39;2019-01-01 17:00:00&#39;),
 Timestamp(&#39;2019-01-01 18:00:00&#39;),
 Timestamp(&#39;2019-01-01 19:00:00&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;y_train&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;step_1&#39;, &#39;step_2&#39;, &#39;step_3&#39;, &#39;step_4&#39;, &#39;step_5&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dimension_info</span><span class="p">[</span><span class="s2">&quot;y_train&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;pm2.5&#39;, &#39;co&#39;, &#39;no&#39;, &#39;o3&#39;]
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks-rnn-and-long-short-term-memory-lstm">Recurrent Neural Networks (RNN) and Long Short-Term Memory (LSTM)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#libraries">Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-in-time-series-modeling">Types of problems in time series modeling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#single-step-forecasting-predict-one-step-ahead-of-a-single-series-using-the-same-series-as-predictor">1:1 Single-Step Forecasting - Predict one step ahead of a single series using the same series as predictor.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-step-forecasting-predict-a-single-series-using-the-same-series-as-predictor-multiple-steps-ahead">1:1 Multiple-Step Forecasting - Predict a single series using the same series as predictor. Multiple steps ahead.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#n-1-multiple-step-forecasting-predict-one-series-using-multiple-series-as-predictors">N:1 Multiple-Step Forecasting - Predict one series using multiple series as predictors.</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#n-m-multiple-step-forecasting-multiple-time-series-with-multiple-outputs">N:M Multiple-Step Forecasting - Multiple time series with multiple outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-and-compile-tensorflow-models">Create and compile Tensorflow models</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-training-and-test-matrices">Get training and test matrices</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>